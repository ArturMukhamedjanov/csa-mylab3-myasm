# AmAsm. Транслятор и модель

- P3214, Мухамеджанов Артур Илдусович.
- `asm | acc | neum | hw | instr | binary| trap | mem | pstr | prob1 `
- Без усложнения

## Язык программирования

### Синтаксис

**Форма Бэкуса-Наура:**

```ebnf
<программа> ::= <строка_программы> | <строка_программы> <программа>
<строка_программы> ::= <адрес> | [<метка>] <адресная команда> <операнд> | 
[<метка>] <безадресная команда> | [<метка>] <метка константы> <константа> | <пустая строка> 

<метка> ::= <слово>
<адресная команда> = add | load | store | ... | sub | jmp | (см. систему команд)
<безадресная команда> ::= cla | di | ei | ... | hlt
<операнд> ::= <число> | <метка>
<константа> ::= <число> | <число> '<слово>'
<слово> ::= <символ> | <слово> <символ>
<число> ::= <цифра> | <число> <цифра>
<цифра> ::= 0| 1 | 2 | .. | 8 | 9
<символ> ::= a | b | c | ... | z | A | B | C | ... | Z | <цифра>
```

**Пояснение:**

Каждая непустая строка программы это одно из нижеперечисленных:

* **адресная команда**
    * может иметь метку в начале
    * указывается название команды и адрес операнда через пробел
* **безадресная команда**
    * может иметь метку в начале
    * указывается только название команды
* **константа**
    * может иметь метку в начале
    * указывается метка константы `word:` и константа
    * константа может быть 16-битным знаковым числом
    * константа может быть строкой: указывается длина строки и строка через пробел
* **адрес**
    * указывается специальное слово `org` и адрес в десятичном формате

Пример программы, вычисляющей С = A + B

```asm
org 5
A: word: 10
B: word: 15
C: word: 0

start: cla
load A
add B
store C
hlt
```

**Семантика**

- Видимость данных -- глобальная
- Поддерживаются целочисленные литералы, находящиеся в диапазоне от $`-2^{31}`$ до $`2^{31}-1`$
- Поддерживаются строковые литералы, символы стоки необходимо заключить в кавычки, перед строкой через запятую необходимо указать длину
- Код выполняется последовательно

- Программа обязательно должна включать метку `start:`, указывающую на 1-ю выполняемую интсрукцию. Эта метка не может
  указывать на константу.
- Название метки не должно совпадать с названием команды и не может начинаться с цифры.
- Метки находятся на одной строке с командами, операнды находятся на одной строке с командами.
- Пустые строки игнорируются, количество пробелов в начале и конце строки не важно.
- Любой текст, расположенный в конце строки после символа `';'` трактуется как комментарий.

Память выделяется статически, при запуске модели.

## Организация памяти

* Память команд и данныx --- общая
* Размер машинного слова --- `32` бит
* Память содержит `2^11` ячеек
* Ячейка с адресом `0` зарезервирована под вектор прерывания устройства ввода
* Адрес `2045` является указателем стека при старте процессора. Стек растет вверх.
* Ячейка с адресом `2046` маппится на устройство ввода
* Ячейка с адресом `2047` маппится на устройство вывода


* Поддерживаются следующие **виды адресаций**:
    * **Прямая**: в качестве аргумента команды передается адрес ячейки, значение в которой будет использовано как
      операнд.
      Например, если `mem[30] = 25`, то команда `add 30` обозначает, что к значению в аккумуляторе добавится число 25.

    * **Косвенная**: в качестве аргумента команды передается адрес, по которому лежит адрес операнда.
      Например, если `mem[30] = 25`, `mem[33] = 30`, то команда `add (33)` также обозначает, что к аккумулятору
      добавится значение 25.


* Существует несколько **регистров**:
    * Аккумулятор (AC): в него записываются результаты всех операций
    * Счетчик команд (IP): хранит адрес следующей выполняемой команды
    * Указатель стека (SP): при вызове прерывания текущее состояние счетчика команд сохраняется на стеке
    * Регистр состояния (PS): хранит маркер того, что наступило прерывание

      ```
        | ie/id | ir | N | Z | C |
         4        3    2   1   0
      ```
        * 0-й бит хранит значение флага C
        * 1-й бит хранит значение флага Z
        * 2-й бит хранит значение флага N
        * 3-й бит содержит 1, если поступил запрос прерывания, и 0 иначе
        * 4-й бит содержит 1, если прерывания разрешены (interrupts enabled) и 0, если запрещены (interrupts disabled)


* Регистр данных (DR): хранит данные для записи в память и считывания из памяти
* Регистр адреса (AR): хранит адрес последней ячейки в памяти, к которой было обращение

## Система команд

Особенности процессора:

- Машинное слово -- `32` бита, знаковое.
- В качестве аргументов команды принимают `11` битные беззнаковые адреса

Каждая команда выполняется в несколько циклов:

1. Цикл выборки команды: по адресу из счетчика команд из памяти достается команда

- `IP -> AR, IP + 1 -> IP, mem[AR] -> DR, DR -> CR`

2. Цикл выборки операнда (для адресных команд): в регистр данных помещается адрес операнда, регистр данных передавется в
   регистр адреса, из памяти в регистр данных записывается значение операнда

- `CR[addr] -> DR, DR -> AR, mem[AR] -> DR`

3. Цикл исполнения: совершаются действия, необходимые для выполнения команды. Результаты вычисления записываются в
   аккумулятор
4. Цикл прерывания: проверяется, не произошел ли запрос на прерывание

### Набор инструкций

| Язык  | Адресная | Ветвление | Описание                                                                                       |
|:------|:---------|-----------|:-----------------------------------------------------------------------------------------------|
| load  | +        | -         |  загрузить значение из заданной ячейки                                                          |
| store | +        | -         |  загрузить значение в заданную ячейку                           
| add   | +        | -         |  добавить значение из заданной ячейки к аккумулятору                     
| sub   | +        | -         |  вычесть значение из заданной ячейки из аккумулятора                     
| mod   | +        | -         |  получить остаток от деления аккумулятора на значение из ячейки                           
| jmp   | +        | +         |  перейти в заданную ячейку                           
| cmp   | +        | -         |  выставить флаги как результат вычитания заданной ячейки из аккумулятора, сохранить аккумулят
| jmn   | +        | +         |  перейти в заданную ячейку если N = 1                                
| jmnn  | +        | +         |  перейти в заданную ячейку если N = 0                                
| jmc   | +        | +         |  перейти в заданную ячейку если C = 1                                
| jmnc  | +        | +         |  перейти в заданную ячейку если C = 0                                
| jmz   | +        | +         |  перейти в заданную ячейку если Z = 1                                
| jmnz  | +        | +         |  перейти в заданную ячейку если Z = 0                                
| asl   | -        | -         |  сдвинуть значение в аккумуляторе влево, AC[15] -> C                                
| asr   | -        | -         |  сдвинуть значение в аккумуляторе вправо, AC[0] -> C                                
| dec   | -        | -         |  уменьшить значение в аккумуляторе на 1                                
| inc   | -        | -         |  увеличить значение в аккумуляторе на 1                                
| cla   | -        | -         |  очистить аккумулятор (записать в него 0)                               
| hlt   | -        | -         |  остановить работу программы                        |
| iret  | -        | -         |  возрат из прерывания                               |
| push  | -        | -         |  положить значение из аккумулятора на стек                             
| pop   | -        | -         |  достать значение с вершины стека и записать в аккумулятор                      
| di    | -        | -         |  запретить прерывания                               |
| ei    | -        | -         |  разрешить прерывания                               |
| nop   | -        | -         |  отсутствие операции                                                                            |

Коды команда:
00000 - add
00001 - load 
00010 - store
00011 - cmp  
00100 - mod  
00101 - jmp  
00110 - jmn  
00111 - jmnn 
01000 - jmz  
01001 - jmnz
01010 - jmc
01011 - jmnc
01100 - hlt
01101 - cla
01110 - iret
01111 - asl
10000 - asr
10001 - inc
10010 - dec
10011 - push
10100 - pop
10101 - di
10110 - ei
10111 - nop

## Бинарные файлы
### Состав фалйа
- Первые 4 байта - индекс старта
- Последующие байты: 4 байта - индекс инструкции, 4 байта - инструкция
### Кодирование инструкций
Каждая инструкция/адреса инструкций кодируются 32 битами.
Значения битов инструкций: 
- 32 - команда или данные(если 0 (данные) то все остальное - данные)
- 31 - Если команда - адресная(1) или безадресная(0), Если данные - число(0) или символ(1)
- 30 - Если адресная: косвенная или относительная адресация
- 29 - 25 - код команды
- 24 - 14 - адрес ячейки операнда
- 13 - 0 - нули, если команда



